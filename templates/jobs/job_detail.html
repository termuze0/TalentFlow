{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ job.title }} | TalentFlow</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{% static 'job_detail.css' %}">
</head>
<body>
  {% include 'partials/navbar.html' %}
  
  <div class="container">
    <div class="job-detail-card">
      <div class="job-header">
        <div>
          <h1 class="job-title">{{ job.title }}</h1>
          <div class="job-meta">
            <span><i class="fas fa-building"></i> {{ job.employer.fullname }}</span>
            <span><i class="fas fa-map-marker-alt"></i> {{ job.location }}</span>
            {% if job.salary %}
              <span><i class="fas fa-money-bill-wave"></i> ${{ job.salary|floatformat:"0" }}</span>
            {% endif %}
            <span><i class="far fa-calendar-alt"></i> {{ job.deadline|date:"M d, Y" }}</span>
            <span><i class="fas fa-tag"></i> {{ job.category.name }}</span>
          </div>
        </div>
        <button id="save-job-btn" class="btn btn-save" data-job-id="{{ job.id }}">
          <i class="far fa-bookmark"></i> Save Job
        </button>
      </div>
      
      <div class="job-section">
        <h3><i class="fas fa-align-left"></i> Job Description</h3>
        <p>{{ job.description|linebreaks }}</p>
      </div>
      
      <div class="job-section">
        <h3><i class="fas fa-clipboard-check"></i> Requirements</h3>
        <p>{{ job.requirements|linebreaks }}</p>
      </div>
      
      <div class="job-actions">
        <button class="btn btn-primary" id="show-apply-form">
          <i class="fas fa-paper-plane"></i> Apply Now
        </button>
        <a href="/jobs" class="btn btn-danger">
          <i class="fas fa-arrow-left"></i> Back to Jobs
        </a>
      </div>

      <div class="apply-form" id="apply-form" style="display: none;">
        <h3><i class="fas fa-edit"></i> Application Form</h3>
        <form id="job-application-form" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group">
            <label for="full_name">Full Name</label>
            <input type="text" class="form-control" id="full_name" name="full_name" required>
          </div>
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" class="form-control" id="email" name="email" required>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" class="form-control" id="phone" name="phone" required>
          </div>
          <div class="form-group">
            <label for="resume">Upload Resume (PDF only)</label>
            <input type="file" class="form-control" id="resume" name="resume" accept=".pdf" required>
          </div>
          <div class="form-group">
            <label for="cover_letter">Cover Letter</label>
            <textarea class="form-control" id="cover_letter" name="cover_letter" required></textarea>
          </div>
          <button type="submit" class="submit-btn">
            <i class="fas fa-paper-plane"></i> Submit Application
          </button>
        </form>
      </div>
    </div>
  </div>
  <script>
document.addEventListener('DOMContentLoaded', async function () {
    
    const themeToggle = document.getElementById('themeToggle'); 
    const themeIcon = document.getElementById('themeIcon');     
    const html = document.documentElement;

    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
        html.setAttribute('data-theme', 'dark');
        if (themeIcon) themeIcon.classList.replace('fa-moon', 'fa-sun');
    }

    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            const isDark = html.getAttribute('data-theme') === 'dark';
            if (isDark) {
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                if (themeIcon) themeIcon.classList.replace('fa-sun', 'fa-moon');
            } else {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                if (themeIcon) themeIcon.classList.replace('fa-moon', 'fa-sun');
            }
        });
    }

    const saveBtn = document.getElementById('save-job-btn');
    const jobId = saveBtn?.dataset.jobId;
    const token = localStorage.getItem('session_token');
    const showApplyFormBtn = document.getElementById('show-apply-form');
    const applyForm = document.getElementById('apply-form');

    if (showApplyFormBtn) {
        showApplyFormBtn.addEventListener('click', () => {
            applyForm.style.display = applyForm.style.display === 'none' ? 'block' : 'none';
        });
    }

    if (!saveBtn || !token) {
        if (saveBtn) saveBtn.style.display = 'none';
        return; 
    }

    
    try {
        const res = await fetch(`/jobs/saved-jobs/${jobId}/status/`, {
            method: 'GET',
            headers: { 'Session-Token': token }
        });
        if (res.ok) {
            const data = await res.json();
            updateButton(data.saved);
        }
    } catch (err) {
        console.error("Could not check saved status", err);
    }

   saveBtn.addEventListener('click', async () => {
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        const res = await fetch(`/jobs/${jobId}/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Session-Token': token
            },
        });
        
        const data = await res.json();
        if (res.ok) {
            console.log("Server response:", data); // Debug the response
            if (data.saved === undefined) {
                console.warn("Saved status is undefined in response");
                showToast("Unexpected response from server", 'error');
                return;
            }
            updateButton(data.saved);
            showToast(data.message); 
        } else {
            showToast(data.error || "Something went wrong.", 'error');
        }
    } catch (err) {
        console.error("Error saving job", err);
        showToast("An error occurred. Please try again.", 'error');
    } finally {
        saveBtn.disabled = false;
    }
});

    const applicationForm = document.getElementById('job-application-form');
    if (applicationForm) {
        applicationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(applicationForm);
            
            try {
                const submitBtn = applicationForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                
                const res = await fetch(`/jobs/${jobId}/apply/`, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Session-Token': token }
                });

                const data = await res.json();
                if (res.ok) {
                    showToast('Application submitted successfully!');
                    applicationForm.reset();
                    applyForm.style.display = 'none';
                } else {
                    showToast(data.error || "Failed to submit application", 'error');
                }
            } catch (err) {
                console.error("Error submitting application", err);
                showToast("An error occurred. Please try again.", 'error');
            } finally {
                const submitBtn = applicationForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Application';
            }
        });
    }

    function updateButton(isSaved) {
        if (isSaved) {
            saveBtn.innerHTML = '<i class="fas fa-bookmark"></i> Unsave Job';
            saveBtn.classList.remove('btn-save');
            saveBtn.classList.add('btn-unsave');
        } else {
            saveBtn.innerHTML = '<i class="far fa-bookmark"></i> Save Job';
            saveBtn.classList.remove('btn-unsave');
            saveBtn.classList.add('btn-save');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : 'var(--danger-color)';
        toast.style.color = 'white';
        toast.style.padding = '12px 24px';
        toast.style.borderRadius = 'var(--border-radius)';
        toast.style.boxShadow = 'var(--box-shadow)';
        toast.style.zIndex = '1000';
        toast.style.transition = 'all 0.3s ease';
        toast.style.display = 'flex';
        toast.style.alignItems = 'center';
        toast.style.gap = '10px';
        toast.textContent = message;
        
        const icon = document.createElement('i');
        icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        toast.prepend(icon);
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
});
</script>

</body>
</html>